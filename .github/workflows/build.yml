name: Build iOS IPA

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install xcodegen
      run: brew install xcodegen
    
    - name: Create project.yml
      run: |
        cat > project.yml << 'EOF'
        name: åŽä»”è¶£çŽ©ç¤¾
        options:
          bundleIdPrefix: com.huazai
          deploymentTarget:
            iOS: "12.0"
          xcodeVersion: "15.0"
        
        settings:
          base:
            SWIFT_VERSION: "5.0"
            TARGETED_DEVICE_FAMILY: "1,2"
            CODE_SIGN_IDENTITY: "-"
            CODE_SIGNING_REQUIRED: NO
            CODE_SIGNING_ALLOWED: NO
        
        targets:
          åŽä»”è¶£çŽ©ç¤¾:
            type: application
            platform: iOS
            sources:
              - path: åŽä»”è¶£çŽ©ç¤¾
                excludes:
                  - "**/.DS_Store"
            settings:
              base:
                INFOPLIST_FILE: åŽä»”è¶£çŽ©ç¤¾/Info.plist
                PRODUCT_BUNDLE_IDENTIFIER: com.huazai.quwan
                LD_RUNPATH_SEARCH_PATHS: "$(inherited) @executable_path/Frameworks"
            info:
              path: åŽä»”è¶£çŽ©ç¤¾/Info.plist
        EOF
    
    - name: Generate Xcode Project
      run: xcodegen generate
    
    - name: Build Archive
      run: |
        xcodebuild \
          -project åŽä»”è¶£çŽ©ç¤¾.xcodeproj \
          -scheme åŽä»”è¶£çŽ©ç¤¾ \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -archivePath build/åŽä»”è¶£çŽ©ç¤¾.xcarchive \
          archive \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO
    
    - name: Create Unsigned IPA
      run: |
        mkdir -p Payload
        cp -r build/åŽä»”è¶£çŽ©ç¤¾.xcarchive/Products/Applications/åŽä»”è¶£çŽ©ç¤¾.app Payload/
        zip -r åŽä»”è¶£çŽ©ç¤¾-unsigned.ipa Payload
        echo "âœ… IPA created: $(ls -lh åŽä»”è¶£çŽ©ç¤¾-unsigned.ipa)"
    
    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: åŽä»”è¶£çŽ©ç¤¾-unsigned-IPA
        path: åŽä»”è¶£çŽ©ç¤¾-unsigned.ipa
        retention-days: 30
        if-no-files-found: error
    
    - name: Build Summary
      run: |
        echo "================================"
        echo "âœ… æž„å»ºæˆåŠŸï¼"
        echo "================================"
        echo ""
        echo "ðŸ“± IPA æ–‡ä»¶: åŽä»”è¶£çŽ©ç¤¾-unsigned.ipa"
        echo "ðŸ“¦ æ–‡ä»¶å¤§å°: $(du -h åŽä»”è¶£çŽ©ç¤¾-unsigned.ipa | cut -f1)"
        echo ""
        echo "âš ï¸  æ­¤ IPA æœªç­¾åï¼Œéœ€è¦ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å®‰è£…ï¼š"
        echo "   - AltStore (å…è´¹ Apple ID ç­¾å)"
        echo "   - Sideloadly (å…è´¹ Apple ID ç­¾å)"
        echo "   - è‡ªç­¾åè¯ä¹¦"
